<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth Testing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .sections-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      height: fit-content;
    }
    
    .form-group {
      margin: 10px 0;
    }
    
    .email-group {
      display: flex;
      gap: 5px;
      align-items: end;
    }
    
    .email-input {
      flex: 1;
    }
    
    .domain-select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      min-width: 120px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }
    
    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    
    button {
      background: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
      font-size: 14px;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
      font-size: 13px;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .warn {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    h2 {
      margin-top: 0;
      color: #007bff;
      font-size: 18px;
    }
    
    h3 {
      margin: 15px 0 10px 0;
      font-size: 16px;
      color: #555;
    }
    
    /* Responsive: En pantallas peque√±as vuelve a una columna */
    @media (max-width: 768px) {
      .sections-container {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      body {
        max-width: 600px;
        padding: 15px;
      }
      
      .email-group {
        flex-direction: column;
        gap: 5px;
      }
      
      .domain-select {
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <h1>Auth Testing - ByteTechEdu</h1>
  
  <div class="sections-container">
     <!-- Registro  -->
    <div class="section">
      <h2>Registro</h2>
      <form id="formSignup">
        <div class="form-group">
          <label>Nombre</label>
          <input id="su-name" type="text" required />
        </div>
        <div class="form-group">
          <label>Email</label>
          <div class="email-group">
            <input id="su-email" class="email-input" type="text" placeholder="usuario" required />
            <select id="su-domain" class="domain-select">
              <option value="@gmail.com">@gmail.com</option>
              <option value="@hotmail.com">@hotmail.com</option>
              <option value="@outlook.com">@outlook.com</option>
              <option value="@yahoo.com">@yahoo.com</option>
              <option value="@icloud.com">@icloud.com</option>
              <option value="">Personalizado</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input id="su-pass" type="password" required />
        </div>
        <div class="form-group">
          <label>
            <input id="su-sensei" type="checkbox" /> Es Sensei
          </label>
        </div>
        <button type="submit">Registrar</button>
        <div id="msgSignup" class="message"></div>
      </form>
    </div>

     <!-- Verificaci√≥n -->
    <div class="section">
      <h2>Verificaci√≥n</h2>
      <form id="formVerify">
        <div class="form-group">
          <label>Email</label>
          <input id="ve-email" type="email" required readonly style="background: #f8f9fa;" />
          <small style="color: #666;">Email del registro completado autom√°ticamente</small>
        </div>
        <div class="form-group">
          <label>C√≥digo</label>
          <input id="ve-code" type="text" required placeholder="123456" />
        </div>
        <button type="submit">Verificar</button>
        <div id="msgVerify" class="message"></div>
      </form>
    </div>

     <!-- Login -->
    <div class="section">
      <h2>Login</h2>
      <form id="formLogin">
        <div class="form-group">
          <label>Email</label>
          <div class="email-group">
            <input id="li-email" class="email-input" type="text" placeholder="usuario" required />
            <select id="li-domain" class="domain-select">
              <option value="@gmail.com">@gmail.com</option>
              <option value="@hotmail.com">@hotmail.com</option>
              <option value="@outlook.com">@outlook.com</option>
              <option value="@yahoo.com">@yahoo.com</option>
              <option value="@icloud.com">@icloud.com</option>
              <option value="">Personalizado</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input id="li-pass" type="password" required />
        </div>
        <button type="submit">Login</button>
        <div id="msgLogin" class="message"></div>
      </form>
    </div>

     <!-- Restaurar Contrase√±a -->
    <div class="section">
      <h2>Restaurar Contrase√±a</h2>
      <h3>Paso 1: Solicitar enlace</h3>
      <form id="formRestoreInit">
        <div class="form-group">
          <label>Email</label>
          <input id="re-email" type="email" required />
        </div>
        <button type="submit">Enviar enlace</button>
        <div id="msgRestoreInit" class="message"></div>
      </form>
      
      <h3>Paso 2: Nueva contrase√±a</h3>
      <form id="formRestore">
        <div class="form-group">
          <label>Token</label>
          <input id="rp-token" type="text" required />
        </div>
        <div class="form-group">
          <label>Nueva contrase√±a</label>
          <input id="rp-pass" type="password" required />
        </div>
        <button type="submit">Actualizar contrase√±a</button>
        <div id="msgRestore" class="message"></div>
      </form>
    </div>
  </div>

  <script>
    // ============================================================================
    // ‚öôÔ∏è CONFIGURACI√ìN GLOBAL
    // ============================================================================
    // Variables que definen el comportamiento general de la aplicaci√≥n.
    // Son como los "ajustes" de nuestro programa.

    const API_BASE = "http://localhost:8000/api"; // Direcci√≥n base de tu backend

    // Estado global de la aplicaci√≥n.
    // Usamos un objeto para mantener la informaci√≥n centralizada.
    // Es como una pizarra donde todos pueden ver y actualizar datos importantes.
    const appState = {
      registeredEmail: '', // Guarda el √∫ltimo email usado en el registro para auto-completar
    };

    // ============================================================================
    // üêõ DEBUGGING FUNCTIONS (Actor: Desarrollador)
    // ============================================================================
    // Funciones para ayudar al desarrollador a entender qu√© est√° pasando.
    // No afectan la l√≥gica de la aplicaci√≥n, solo la visibilidad.

    /**
     * Muestra un mensaje en un elemento HTML.
     * Es una funci√≥n IMPURA porque interact√∫a con el DOM (modifica la interfaz).
     * @param {HTMLElement} element - El elemento HTML donde se mostrar√° el mensaje.
     * @param {string} text - El texto del mensaje a mostrar.
     * @param {string} type - El tipo de mensaje ('success', 'error', 'warn') para aplicar estilos.
     */
    const showMessage = (element, text, type = "success") => {
      element.className = `message ${type}`; // Cambia las clases CSS del elemento
      element.textContent = text;             // Establece el texto del elemento
      element.style.display = "block";        // Hace visible el elemento
    };

    /**
     * Oculta un elemento HTML.
     * Es una funci√≥n IMPURA porque interact√∫a con el DOM (modifica la interfaz).
     * @param {HTMLElement} element - El elemento HTML a ocultar.
     */
    const hideMessage = (element) => {
      element.style.display = "none"; // Oculta el elemento
    };

    /**
     * Registra un mensaje en la consola del navegador para depuraci√≥n.
     * Es una funci√≥n IMPURA porque realiza una operaci√≥n de E/S (entrada/salida) en la consola.
     * @param {string} label - Una etiqueta para identificar el mensaje en la consola.
     * @param {any} data - Los datos a registrar.
     */
    const debugLog = (label, data) => {
      console.log(`üîç ${label}:`, data); // Imprime en la consola del navegador
    };

    // ============================================================================
    // üé® FRONTEND FUNCTIONS (Actor: Interfaz de Usuario / L√≥gica de UI)
    // ============================================================================
    // Funciones que manejan la l√≥gica de la interfaz de usuario y la preparaci√≥n de datos.

    /**
     * Construye un email completo a partir de un nombre de usuario y un dominio.
     * Es una funci√≥n PURA: dado el mismo `username` y `domain`, siempre devuelve el mismo `email`.
     * No tiene efectos secundarios (no modifica nada fuera de la funci√≥n).
     * @param {string} username - La parte del email antes del '@' (ej. "juan.perez").
     * @param {string} domain - El dominio del email (ej. "@gmail.com" o vac√≠o para personalizado).
     * @returns {string} El email completo (ej. "juan.perez@gmail.com").
     */
    const buildFullEmail = (username, domain) => {
      // Si el dominio es vac√≠o, significa que el usuario escribi√≥ el email completo.
      return domain === '' ? username : username + domain;
    };

    /**
     * Actualiza el placeholder y el tipo de input de un campo de email.
     * Es una funci√≥n IMPURA porque interact√∫a con el DOM (modifica atributos de elementos).
     * @param {HTMLInputElement} emailInput - El elemento input del email.
     * @param {HTMLSelectElement} domainSelect - El elemento select del dominio.
     */
    const updateEmailInputDisplay = (emailInput, domainSelect) => {
      if (domainSelect.value === '') {
        emailInput.placeholder = 'usuario@ejemplo.com'; // Sugiere email completo
        emailInput.type = 'email'; // Cambia a tipo email para validaci√≥n nativa
      } else {
        emailInput.placeholder = 'usuario'; // Sugiere solo el nombre de usuario
        emailInput.type = 'text'; // Vuelve a tipo texto para permitir solo el nombre
      }
    };

    /**
     * Auto-completa el campo de email en el formulario de verificaci√≥n.
     * Es una funci√≥n IMPURA porque interact√∫a con el DOM (modifica el valor de un input)
     * y actualiza el estado global (`appState`).
     * @param {string} email - El email a auto-completar.
     */
    const autoFillVerificationEmail = (email) => {
      const verifyEmailInput = document.getElementById("ve-email");
      verifyEmailInput.value = email; // Establece el valor del input
      appState.registeredEmail = email; // Actualiza el estado global
      debugLog("Auto-filled verification email", email);
    };

    // ============================================================================
    // üåê BACKEND FUNCTIONS (Actor: Servidor / API)
    // ============================================================================
    // Funciones que se encargan de la comunicaci√≥n con el servidor backend.

    /**
     * Realiza una petici√≥n HTTP POST a un endpoint del backend.
     * Es una funci√≥n IMPURA porque realiza operaciones de red (E/S).
     * Su complejidad ciclom√°tica es controlada por el `try...catch` y la l√≥gica de parseo.
     * @param {string} url - La URL completa del endpoint del backend.
     * @param {FormData} formData - Los datos del formulario a enviar.
     * @returns {Promise<Object>} Una promesa que resuelve con un objeto { ok, status, data }.
     */
    const makeApiRequest = async (url, formData) => {
      debugLog("Sending API request", { url, formData });
      try {
        const response = await fetch(url, {
          method: "POST",
          credentials: "include", // Importante para enviar cookies de sesi√≥n
          body: formData          // El navegador se encarga del Content-Type con FormData
        });
        
        const responseText = await response.text(); // Leer la respuesta como texto
        let parsedData;
        
        // Intentar parsear la respuesta como JSON. Si falla, usar el texto plano.
        try {
          parsedData = JSON.parse(responseText);
        } catch (e) {
          parsedData = responseText; // No es JSON, usar el texto directamente
        }
        
        debugLog("API response received", { ok: response.ok, status: response.status, data: parsedData });
        return {
          ok: response.ok,      // true si la respuesta HTTP fue 2xx
          status: response.status, // C√≥digo de estado HTTP (ej. 200, 400)
          data: parsedData      // Datos de la respuesta (JSON parseado o texto)
        };
        
      } catch (error) {
        // Captura errores de red (ej. servidor no disponible)
        debugLog("API request failed (network error)", error);
        return {
          ok: false,
          status: 0, // 0 indica un error de red, no un error HTTP del servidor
          data: error.message
        };
      }
    };

    // ============================================================================
    // ‚ö° EVENT HANDLERS (Actor: Interacciones del Usuario)
    // ============================================================================
    // Funciones que responden a las acciones del usuario en los formularios.
    // Son IMPURAS porque interact√∫an con el DOM y llaman a funciones de backend.

    /**
     * Maneja el env√≠o del formulario de Registro.
     * @param {Event} event - El evento de env√≠o del formulario.
     */
    const handleSignupFormSubmit = async (event) => {
      event.preventDefault(); // Evita que la p√°gina se recargue
      
      const msgElement = document.getElementById("msgSignup");
      hideMessage(msgElement); // Oculta cualquier mensaje anterior
      
      // Obtener los valores de los campos del formulario
      const name = document.getElementById("su-name").value;
      const emailInput = document.getElementById("su-email");
      const domainSelect = document.getElementById("su-domain");
      const fullEmail = buildFullEmail(emailInput.value, domainSelect.value); // Usamos .value directamente
      const password = document.getElementById("su-pass").value;
      const isSensei = document.getElementById("su-sensei").checked;
      
      debugLog("Signup form data", { name, fullEmail, password, isSensei });

      // Crear FormData para la petici√≥n
      const formData = new FormData();
      formData.append("name", name);
      formData.append("email", fullEmail);
      formData.append("password", password);
      formData.append("is_sensei", isSensei);

      // Realizar la petici√≥n al backend
      const result = await makeApiRequest(`${API_BASE}/auth/init_register`, formData);
      
      // Mostrar el resultado al usuario
      if (result.ok) {
        showMessage(msgElement, "Usuario registrado. Revisa tu email para el c√≥digo de verificaci√≥n.", "success");
        autoFillVerificationEmail(fullEmail); // Auto-completar email en verificaci√≥n
      } else {
        showMessage(msgElement, `Error: ${result.data}`, "error");
      }
    };

    /**
     * Maneja el env√≠o del formulario de Verificaci√≥n.
     * @param {Event} event - El evento de env√≠o del formulario.
     */
    const handleVerifyFormSubmit = async (event) => {
      event.preventDefault();
      
      const msgElement = document.getElementById("msgVerify");
      hideMessage(msgElement);
      
      const email = document.getElementById("ve-email").value;
      const code = document.getElementById("ve-code").value;
      
      debugLog("Verify form data", { email, code });

      const formData = new FormData();
      formData.append("email", email);
      formData.append("code", code);

      const result = await makeApiRequest(`${API_BASE}/auth/verify_register`, formData);
      
      if (result.ok) {
        showMessage(msgElement, "Usuario verificado correctamente.", "success");
      } else {
        showMessage(msgElement, `Error: ${result.data}`, "error");
      }
    };

    /**
     * Maneja el env√≠o del formulario de Login.
     * @param {Event} event - El evento de env√≠o del formulario.
     */
    const handleLoginFormSubmit = async (event) => {
      event.preventDefault();
      
      const msgElement = document.getElementById("msgLogin");
      hideMessage(msgElement);
      
      const emailInput = document.getElementById("li-email");
      const domainSelect = document.getElementById("li-domain");
      const fullEmail = buildFullEmail(emailInput.value, domainSelect.value);
      const password = document.getElementById("li-pass").value;
      
      debugLog("Login form data", { fullEmail, password });

      const formData = new FormData();
      formData.append("email", fullEmail);
      formData.append("password", password);

      const result = await makeApiRequest(`${API_BASE}/auth/login`, formData);
      
      if (result.ok) {
        showMessage(msgElement, "Login exitoso.", "success");
      } else {
        showMessage(msgElement, `Error: ${result.data}`, "error");
      }
    };

    /**
     * Maneja el env√≠o del formulario de inicio de Restauraci√≥n de Contrase√±a.
     * @param {Event} event - El evento de env√≠o del formulario.
     */
    const handleRestoreInitFormSubmit = async (event) => {
      event.preventDefault();
      
      const msgElement = document.getElementById("msgRestoreInit");
      hideMessage(msgElement);
      
      const email = document.getElementById("re-email").value;
      
      debugLog("Restore Init form data", { email });

      const formData = new FormData();
      formData.append("email", email);

      const result = await makeApiRequest(`${API_BASE}/auth/init_restore_password`, formData);
      
      if (result.ok) {
        showMessage(msgElement, "Enlace enviado a tu email.", "success");
      } else {
        showMessage(msgElement, `Error: ${result.data}`, "error");
      }
    };

    /**
     * Maneja el env√≠o del formulario de completar Restauraci√≥n de Contrase√±a.
     * @param {Event} event - El evento de env√≠o del formulario.
     */
    const handleRestoreFormSubmit = async (event) => {
      event.preventDefault();
      
      const msgElement = document.getElementById("msgRestore");
      hideMessage(msgElement);
      
      const token = document.getElementById("rp-token").value;
      const newPassword = document.getElementById("rp-pass").value;
      
      debugLog("Restore Complete form data", { token, newPassword });

      const formData = new FormData();
      formData.append("token", token);
      formData.append("new_password", newPassword);

      const result = await makeApiRequest(`${API_BASE}/auth/restore_password`, formData);
      
      if (result.ok) {
        showMessage(msgElement, "Contrase√±a actualizada correctamente.", "success");
      } else {
        showMessage(msgElement, `Error: ${result.data}`, "error");
      }
    };

    // ============================================================================
    // üöÄ INITIALIZATION (Actor: Sistema / Arranque de la Aplicaci√≥n)
    // ============================================================================
    // C√≥digo que se ejecuta una vez cuando la p√°gina se carga para configurar todo.

    /**
     * Funci√≥n principal de inicializaci√≥n de la aplicaci√≥n.
     * Se ejecuta cuando el DOM (estructura HTML) est√° completamente cargado.
     * Es una funci√≥n IMPURA porque configura listeners y modifica el DOM.
     */
    document.addEventListener('DOMContentLoaded', () => {
      debugLog("DOM Content Loaded", "Starting application initialization...");

      // Configurar los dropdowns de dominio para los campos de email
      // Cada dropdown tiene su propio listener para actualizar el placeholder del input asociado.
      document.getElementById('su-domain').addEventListener('change', () => {
        updateEmailInputDisplay(document.getElementById('su-email'), document.getElementById('su-domain'));
      });
      document.getElementById('li-domain').addEventListener('change', () => {
        updateEmailInputDisplay(document.getElementById('li-email'), document.getElementById('li-domain'));
      });
      
      // Asignar los manejadores de eventos a cada formulario.
      // Cuando un formulario se env√≠a, se llama a la funci√≥n `handleSubmit` correspondiente.
      document.getElementById("formSignup").addEventListener("submit", handleSignupFormSubmit);
      document.getElementById("formVerify").addEventListener("submit", handleVerifyFormSubmit);
      document.getElementById("formLogin").addEventListener("submit", handleLoginFormSubmit);
      document.getElementById("formRestoreInit").addEventListener("submit", handleRestoreInitFormSubmit);
      document.getElementById("formRestore").addEventListener("submit", handleRestoreFormSubmit);
      
      debugLog("Initialization Complete", "All event listeners attached successfully.");
    });
  </script>
</body>
</html>